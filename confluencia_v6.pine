//@version=6
//Â© Diego Santacruz
indicator(title="Sistema de Confluencia v6", shorttitle="Confluence", overlay=true)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Confluencia mÃ­nima requerida
min_confluence = input.int(3, "Confluencia MÃ­nima (de 5)", minval=2, maxval=5, group="Sistema")
show_weak_signals = input.bool(false, "Mostrar SeÃ±ales DÃ©biles", group="Sistema",
     tooltip="Mostrar seÃ±ales con confluencia menor a la mÃ­nima")

// VisualizaciÃ³n
show_signals = input.bool(true, "Mostrar SeÃ±ales", group="VisualizaciÃ³n")
show_indicators = input.bool(true, "Mostrar Indicadores en Chart", group="VisualizaciÃ³n")
show_table = input.bool(true, "Mostrar Tabla de Confluencia", group="VisualizaciÃ³n")

// Alertas
enable_alerts = input.bool(true, "Activar Alertas", group="Alertas")

// ParÃ¡metros de indicadores (ajustables)
ema_fast = input.int(20, "EMA RÃ¡pida", minval=1, group="ParÃ¡metros")
ema_slow = input.int(50, "EMA Lenta", minval=1, group="ParÃ¡metros")
ema_trend = input.int(200, "EMA Tendencia", minval=1, group="ParÃ¡metros")
rsi_length = input.int(14, "RSI Length", minval=1, group="ParÃ¡metros")
macd_fast = input.int(12, "MACD Fast", minval=1, group="ParÃ¡metros")
macd_slow = input.int(26, "MACD Slow", minval=1, group="ParÃ¡metros")
macd_signal = input.int(9, "MACD Signal", minval=1, group="ParÃ¡metros")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOM TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

type IndicatorSignal
    bool bullish        // SeÃ±al alcista del indicador
    bool bearish        // SeÃ±al bajista del indicador
    float strength      // Fuerza de la seÃ±al (0-1)
    string status       // Estado descriptivo

type ConfluenceResult
    int bullish_count   // Cantidad de indicadores alcistas
    int bearish_count   // Cantidad de indicadores bajistas
    float bull_score    // Score alcista (0-100)
    float bear_score    // Score bajista (0-100)
    bool strong_buy     // SeÃ±al fuerte de compra
    bool strong_sell    // SeÃ±al fuerte de venta
    string recommendation // RecomendaciÃ³n textual

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICADOR 1: MEDIAS MÃ“VILES (EMAs)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calc_ema_signal() =>
    ema20 = ta.ema(close, ema_fast)
    ema50 = ta.ema(close, ema_slow)
    ema200 = ta.ema(close, ema_trend)

    // Cruce de medias
    golden_cross = ta.crossover(ema20, ema50)
    death_cross = ta.crossunder(ema20, ema50)

    // AlineaciÃ³n de tendencia
    uptrend = close > ema200
    downtrend = close < ema200

    // AlineaciÃ³n completa
    full_bullish = ema20 > ema50 and ema50 > ema200
    full_bearish = ema20 < ema50 and ema50 < ema200

    // Calcular fuerza (0-1)
    strength_bull = 0.0
    strength_bear = 0.0

    if golden_cross and uptrend
        strength_bull := 1.0
    else if ema20 > ema50 and uptrend
        strength_bull := 0.7
    else if uptrend
        strength_bull := 0.3

    if death_cross and downtrend
        strength_bear := 1.0
    else if ema20 < ema50 and downtrend
        strength_bear := 0.7
    else if downtrend
        strength_bear := 0.3

    // Estado
    status = full_bullish ? "Alcista Fuerte" :
             full_bearish ? "Bajista Fuerte" :
             uptrend ? "Alcista" :
             downtrend ? "Bajista" : "Neutral"

    [IndicatorSignal.new(strength_bull > 0.5, strength_bear > 0.5, math.max(strength_bull, strength_bear), status),
     ema20, ema50, ema200]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICADOR 2: MACD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calc_macd_signal() =>
    [macd_line, signal_line, hist] = ta.macd(close, macd_fast, macd_slow, macd_signal)

    // Cruces
    bullish_cross = ta.crossover(macd_line, signal_line)
    bearish_cross = ta.crossunder(macd_line, signal_line)

    // PosiciÃ³n respecto a cero
    above_zero = macd_line > 0
    below_zero = macd_line < 0

    // Histograma creciendo/decreciendo
    hist_growing = hist > hist[1]
    hist_falling = hist < hist[1]

    // Calcular fuerza
    strength_bull = 0.0
    strength_bear = 0.0

    if bullish_cross and above_zero
        strength_bull := 1.0
    else if bullish_cross
        strength_bull := 0.7
    else if macd_line > signal_line and hist_growing
        strength_bull := 0.5
    else if macd_line > signal_line
        strength_bull := 0.3

    if bearish_cross and below_zero
        strength_bear := 1.0
    else if bearish_cross
        strength_bear := 0.7
    else if macd_line < signal_line and hist_falling
        strength_bear := 0.5
    else if macd_line < signal_line
        strength_bear := 0.3

    // Estado
    status = bullish_cross ? "Cruce Alcista" :
             bearish_cross ? "Cruce Bajista" :
             macd_line > signal_line and above_zero ? "Alcista Fuerte" :
             macd_line < signal_line and below_zero ? "Bajista Fuerte" :
             macd_line > signal_line ? "Alcista" :
             macd_line < signal_line ? "Bajista" : "Neutral"

    IndicatorSignal.new(strength_bull > 0.5, strength_bear > 0.5, math.max(strength_bull, strength_bear), status)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICADOR 3: RSI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calc_rsi_signal() =>
    rsi = ta.rsi(close, rsi_length)

    // Zonas
    oversold = rsi < 30
    overbought = rsi > 70
    neutral_low = rsi >= 30 and rsi < 50
    neutral_high = rsi >= 50 and rsi <= 70

    // Cruces de niveles
    crossing_up_30 = ta.crossover(rsi, 30)
    crossing_down_70 = ta.crossunder(rsi, 70)
    crossing_up_50 = ta.crossover(rsi, 50)
    crossing_down_50 = ta.crossunder(rsi, 50)

    // Calcular fuerza
    strength_bull = 0.0
    strength_bear = 0.0

    if crossing_up_30
        strength_bull := 1.0
    else if crossing_up_50
        strength_bull := 0.8
    else if neutral_high
        strength_bull := 0.5
    else if oversold
        strength_bull := 0.7

    if crossing_down_70
        strength_bear := 1.0
    else if crossing_down_50
        strength_bear := 0.8
    else if neutral_low
        strength_bear := 0.5
    else if overbought
        strength_bear := 0.7

    // Estado
    status = oversold ? "Sobreventa" :
             overbought ? "Sobrecompra" :
             crossing_up_30 ? "Salida Sobreventa" :
             crossing_down_70 ? "Salida Sobrecompra" :
             neutral_high ? "Alcista" :
             neutral_low ? "Bajista" : "Neutral"

    IndicatorSignal.new(strength_bull > 0.5, strength_bear > 0.5, math.max(strength_bull, strength_bear), status)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICADOR 4: VOLUMEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calc_volume_signal() =>
    // Volumen promedio
    vol_ma = ta.sma(volume, 20)

    // Volumen alto = mÃ¡s de 1.5x el promedio
    high_volume = volume > vol_ma * 1.5

    // DirecciÃ³n del precio
    price_up = close > close[1]
    price_down = close < close[1]

    // Vela alcista/bajista fuerte
    body_size = math.abs(close - open)
    avg_body = ta.sma(body_size, 14)
    strong_candle = body_size > avg_body * 1.5

    // Calcular fuerza
    strength_bull = 0.0
    strength_bear = 0.0

    if high_volume and price_up and strong_candle
        strength_bull := 1.0
    else if high_volume and price_up
        strength_bull := 0.7
    else if price_up
        strength_bull := 0.3

    if high_volume and price_down and strong_candle
        strength_bear := 1.0
    else if high_volume and price_down
        strength_bear := 0.7
    else if price_down
        strength_bear := 0.3

    // Estado
    status = high_volume and price_up ? "Compra Fuerte" :
             high_volume and price_down ? "Venta Fuerte" :
             price_up ? "Compra Normal" :
             price_down ? "Venta Normal" : "Neutral"

    IndicatorSignal.new(strength_bull > 0.5, strength_bear > 0.5, math.max(strength_bull, strength_bear), status)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDICADOR 5: MOMENTUM (Rate of Change)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calc_momentum_signal() =>
    // ROC (Rate of Change)
    roc = ta.roc(close, 10)
    roc_ma = ta.sma(roc, 10)

    // Momentum positivo/negativo
    positive_momentum = roc > 0
    negative_momentum = roc < 0

    // Acelerando/desacelerando
    accelerating = roc > roc_ma
    decelerating = roc < roc_ma

    // Calcular fuerza
    strength_bull = 0.0
    strength_bear = 0.0

    if positive_momentum and accelerating and roc > 2
        strength_bull := 1.0
    else if positive_momentum and accelerating
        strength_bull := 0.7
    else if positive_momentum
        strength_bull := 0.4

    if negative_momentum and decelerating and roc < -2
        strength_bear := 1.0
    else if negative_momentum and decelerating
        strength_bear := 0.7
    else if negative_momentum
        strength_bear := 0.4

    // Estado
    status = positive_momentum and accelerating ? "Acelerando â†‘" :
             negative_momentum and decelerating ? "Acelerando â†“" :
             positive_momentum ? "Positivo" :
             negative_momentum ? "Negativo" : "Neutral"

    IndicatorSignal.new(strength_bull > 0.5, strength_bear > 0.5, math.max(strength_bull, strength_bear), status)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃLCULO DE CONFLUENCIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

calc_confluence() =>
    // Obtener seÃ±ales de todos los indicadores
    [ema_sig, ema20, ema50, ema200] = calc_ema_signal()
    macd_sig = calc_macd_signal()
    rsi_sig = calc_rsi_signal()
    vol_sig = calc_volume_signal()
    mom_sig = calc_momentum_signal()

    // Contar votos alcistas y bajistas
    bull_count = 0
    bear_count = 0

    if ema_sig.bullish
        bull_count += 1
    if ema_sig.bearish
        bear_count += 1

    if macd_sig.bullish
        bull_count += 1
    if macd_sig.bearish
        bear_count += 1

    if rsi_sig.bullish
        bull_count += 1
    if rsi_sig.bearish
        bear_count += 1

    if vol_sig.bullish
        bull_count += 1
    if vol_sig.bearish
        bear_count += 1

    if mom_sig.bullish
        bull_count += 1
    if mom_sig.bearish
        bear_count += 1

    // Calcular score ponderado (0-100)
    bull_score = (ema_sig.strength * 25 + macd_sig.strength * 25 +
                  rsi_sig.strength * 20 + vol_sig.strength * 15 +
                  mom_sig.strength * 15)

    bear_score = (ema_sig.strength * 25 + macd_sig.strength * 25 +
                  rsi_sig.strength * 20 + vol_sig.strength * 15 +
                  mom_sig.strength * 15)

    // Solo contar score del lado correcto
    final_bull_score = ema_sig.bullish or macd_sig.bullish or rsi_sig.bullish or
                       vol_sig.bullish or mom_sig.bullish ? bull_score : 0
    final_bear_score = ema_sig.bearish or macd_sig.bearish or rsi_sig.bearish or
                       vol_sig.bearish or mom_sig.bearish ? bear_score : 0

    // SeÃ±ales fuertes (confluencia mÃ­nima alcanzada)
    strong_buy = bull_count >= min_confluence and final_bull_score > 60
    strong_sell = bear_count >= min_confluence and final_bear_score > 60

    // RecomendaciÃ³n
    recommendation =
         strong_buy ? "COMPRAR ğŸš€" :
         strong_sell ? "VENDER âš ï¸" :
         bull_count >= 3 ? "Compra (dÃ©bil)" :
         bear_count >= 3 ? "Venta (dÃ©bil)" :
         bull_count > bear_count ? "Sesgo Alcista" :
         bear_count > bull_count ? "Sesgo Bajista" : "ESPERAR â¸"

    [ConfluenceResult.new(bull_count, bear_count, final_bull_score, final_bear_score,
                          strong_buy, strong_sell, recommendation),
     ema_sig, macd_sig, rsi_sig, vol_sig, mom_sig, ema20, ema50, ema200]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃLCULOS PRINCIPALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[confluence, ema_sig, macd_sig, rsi_sig, vol_sig, mom_sig, ema20, ema50, ema200] = calc_confluence()

// Detectar nuevas seÃ±ales (cambio de estado)
var bool prev_strong_buy = false
var bool prev_strong_sell = false

new_buy_signal = confluence.strong_buy and not prev_strong_buy
new_sell_signal = confluence.strong_sell and not prev_strong_sell

prev_strong_buy := confluence.strong_buy
prev_strong_sell := confluence.strong_sell

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTEO DE INDICADORES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// EMAs
plot(show_indicators ? ema20 : na, "EMA 20", color=color.new(#2196F3, 0), linewidth=2)
plot(show_indicators ? ema50 : na, "EMA 50", color=color.new(#FF9800, 0), linewidth=2)
plot(show_indicators ? ema200 : na, "EMA 200", color=color.new(#9C27B0, 0), linewidth=3)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEÃ‘ALES VISUALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// SeÃ±ales fuertes
if show_signals and new_buy_signal
    label.new(bar_index, low,
         text="COMPRA\n" + str.tostring(confluence.bullish_count) + "/5\n$" + str.tostring(close, "#.##"),
         color=color.new(color.lime, 0),
         textcolor=color.white,
         style=label.style_label_up,
         size=size.small)

if show_signals and new_sell_signal
    label.new(bar_index, high,
         text="VENTA\n" + str.tostring(confluence.bearish_count) + "/5\n$" + str.tostring(close, "#.##"),
         color=color.new(color.maroon, 0),
         textcolor=color.white,
         style=label.style_label_down,
         size=size.small)

// SeÃ±ales dÃ©biles (opcional)
weak_buy = confluence.bullish_count >= 2 and confluence.bullish_count < min_confluence and confluence.bullish_count > confluence.bearish_count
weak_sell = confluence.bearish_count >= 2 and confluence.bearish_count < min_confluence and confluence.bearish_count > confluence.bullish_count

if show_signals and show_weak_signals and weak_buy and not confluence.strong_buy
    label.new(bar_index, low,
         text=str.tostring(confluence.bullish_count) + "/5",
         color=color.new(color.green, 50),
         textcolor=color.white,
         style=label.style_label_up,
         size=size.small)

if show_signals and show_weak_signals and weak_sell and not confluence.strong_sell
    label.new(bar_index, high,
         text=str.tostring(confluence.bearish_count) + "/5",
         color=color.new(color.red, 50),
         textcolor=color.white,
         style=label.style_label_down,
         size=size.small)

// Marcadores en el grÃ¡fico para seÃ±ales fuertes
plotshape(show_signals and new_buy_signal, "Compra Fuerte",
     shape.triangleup, location.belowbar, color.new(color.lime, 0), size=size.small)

plotshape(show_signals and new_sell_signal, "Venta Fuerte",
     shape.triangledown, location.abovebar, color.new(color.maroon, 0), size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLA DE CONFLUENCIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_table and barstate.islast
    var table conf_table = table.new(position.top_right, 3, 9,
         border_width=1,
         border_color=color.gray,
         frame_width=1,
         frame_color=color.gray)

    // Header
    table.cell(conf_table, 0, 0, "Sistema de Confluencia",
         text_color=color.white,
         bgcolor=color.new(color.purple, 20),
         text_size=size.normal)
    table.merge_cells(conf_table, 0, 0, 2, 0)

    // Precio
    table.cell(conf_table, 0, 1, "Precio",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50))
    table.cell(conf_table, 1, 1, "$" + str.tostring(close, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.blue, 70))
    table.merge_cells(conf_table, 1, 1, 2, 1)

    // Confluencia
    conf_text = str.tostring(confluence.bullish_count) + "/5 ğŸŸ¢  " + str.tostring(confluence.bearish_count) + "/5 ğŸ”´"

    table.cell(conf_table, 0, 2, "Confluencia",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50))
    table.cell(conf_table, 1, 2, conf_text,
         text_color=color.white,
         bgcolor=color.new(color.gray, 80))
    table.merge_cells(conf_table, 1, 2, 2, 2)

    // Score
    table.cell(conf_table, 0, 3, "Score",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(conf_table, 1, 3, "ğŸŸ¢ " + str.tostring(confluence.bull_score, "#") + "%",
         text_color=color.white,
         bgcolor=color.new(color.green, 70),
         text_size=size.small)
    table.cell(conf_table, 2, 3, "ğŸ”´ " + str.tostring(confluence.bear_score, "#") + "%",
         text_color=color.white,
         bgcolor=color.new(color.red, 70),
         text_size=size.small)

    // Estado de cada indicador
    table.cell(conf_table, 0, 4, "ğŸ“Š Indicador",
         text_color=color.white,
         bgcolor=color.new(color.gray, 60),
         text_size=size.small)
    table.cell(conf_table, 1, 4, "SeÃ±al",
         text_color=color.white,
         bgcolor=color.new(color.gray, 60),
         text_size=size.small)
    table.cell(conf_table, 2, 4, "Estado",
         text_color=color.white,
         bgcolor=color.new(color.gray, 60),
         text_size=size.small)

    // EMA
    ema_vote = ema_sig.bullish ? "ğŸŸ¢" : ema_sig.bearish ? "ğŸ”´" : "âšª"
    table.cell(conf_table, 0, 5, "EMAs",
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.tiny)
    table.cell(conf_table, 1, 5, ema_vote,
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.small)
    table.cell(conf_table, 2, 5, ema_sig.status,
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.tiny)

    // MACD
    macd_vote = macd_sig.bullish ? "ğŸŸ¢" : macd_sig.bearish ? "ğŸ”´" : "âšª"
    table.cell(conf_table, 0, 6, "MACD",
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.tiny)
    table.cell(conf_table, 1, 6, macd_vote,
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.small)
    table.cell(conf_table, 2, 6, macd_sig.status,
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.tiny)

    // RSI
    rsi_vote = rsi_sig.bullish ? "ğŸŸ¢" : rsi_sig.bearish ? "ğŸ”´" : "âšª"
    table.cell(conf_table, 0, 7, "RSI",
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.tiny)
    table.cell(conf_table, 1, 7, rsi_vote,
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.small)
    table.cell(conf_table, 2, 7, rsi_sig.status,
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.tiny)

    // Volumen + Momentum combinados
    vol_mom_bull = vol_sig.bullish or mom_sig.bullish
    vol_mom_bear = vol_sig.bearish or mom_sig.bearish
    vol_mom_vote = vol_mom_bull ? "ğŸŸ¢" : vol_mom_bear ? "ğŸ”´" : "âšª"
    vol_mom_status = vol_sig.status + " / " + mom_sig.status

    table.cell(conf_table, 0, 8, "Vol/Mom",
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.tiny)
    table.cell(conf_table, 1, 8, vol_mom_vote,
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.small)
    table.cell(conf_table, 2, 8, vol_mom_status,
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.tiny)

// Segunda tabla: RecomendaciÃ³n
if show_table and barstate.islast
    var table rec_table = table.new(position.bottom_right, 2, 2,
         border_width=2,
         border_color=color.gray,
         frame_width=2,
         frame_color=color.gray)

    // Header
    table.cell(rec_table, 0, 0, "RECOMENDACIÃ“N",
         text_color=color.white,
         bgcolor=color.new(color.blue, 20),
         text_size=size.small)
    table.merge_cells(rec_table, 0, 0, 1, 0)

    // RecomendaciÃ³n
    rec_color = confluence.strong_buy ? color.new(color.lime, 30) : confluence.strong_sell ? color.new(color.maroon, 30) :color.new(color.gray, 60)

    rec_text = confluence.recommendation
    if confluence.strong_buy or confluence.strong_sell
        rec_text := rec_text + "\n$" + str.tostring(close, "#.##")

    table.cell(rec_table, 0, 1, rec_text,
         text_color=color.white,
         bgcolor=rec_color,
         text_size=size.normal)
    table.merge_cells(rec_table, 0, 1, 1, 1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(enable_alerts and new_buy_signal,
     "CONFLUENCIA: COMPRA FUERTE",
     "ğŸš€ COMPRAR en ${{close}} - Confluencia: {{plot_0}}/5 indicadores - Score: {{plot_1}}%")

alertcondition(enable_alerts and new_sell_signal,
     "CONFLUENCIA: VENTA FUERTE",
     "âš ï¸ VENDER en ${{close}} - Confluencia: {{plot_0}}/5 indicadores - Score: {{plot_1}}%")

// Plots para alertas
plot(confluence.bullish_count, "Bull Count", display=display.none)
plot(confluence.bull_score, "Bull Score", display=display.none)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GUÃA DE USO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// SISTEMA DE CONFLUENCIA - GUÃA COMPLETA:
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Â¿QUÃ‰ ES LA CONFLUENCIA?
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// La confluencia es cuando MÃšLTIPLES indicadores independientes coinciden
// en la misma direcciÃ³n (alcista o bajista).
//
// En lugar de confiar en UN solo indicador, este sistema analiza 5:
// 1. EMAs (20/50/200) - Tendencia
// 2. MACD - Momentum
// 3. RSI - Fuerza relativa
// 4. Volumen - InterÃ©s del mercado
// 5. Momentum (ROC) - AceleraciÃ³n
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃ“MO LEER LAS SEÃ‘ALES:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Label: "COMPRA FUERTE\n4/5 â­\n$45.23\nScore: 82%"
//
// - COMPRA FUERTE = SeÃ±al de alta probabilidad
// - 4/5 â­ = 4 de 5 indicadores estÃ¡n alcistas (confluencia alta)
// - $45.23 = Precio exacto de la seÃ±al
// - Score: 82% = Confianza ponderada (cuanto mÃ¡s alto, mejor)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NIVELES DE CONFLUENCIA:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// 5/5 â­â­â­â­â­ = PERFECTO (rarÃ­simo pero altÃ­sima probabilidad)
// 4/5 â­â­â­â­ = EXCELENTE (muy buena seÃ±al)
// 3/5 â­â­â­ = BUENA (seÃ±al vÃ¡lida, confluencia mÃ­nima por defecto)
// 2/5 â­â­ = DÃ‰BIL (muestra solo si activas "SeÃ±ales DÃ©biles")
// 1/5 â­ = MUY DÃ‰BIL (no se muestra)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLA DE CONFLUENCIA:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Precio: Precio actual
// Confluencia: X/5 ğŸŸ¢ (alcistas)  Y/5 ğŸ”´ (bajistas)
// Score: Porcentaje de confianza para cada lado
//
// Desglose por indicador:
// ğŸŸ¢ = Voto alcista
// ğŸ”´ = Voto bajista
// âšª = Neutral
//
// Estado: Describe quÃ© estÃ¡ viendo cada indicador
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃ“MO OPERAR:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// REGLA DE ORO: Solo opera cuando aparece "COMPRA FUERTE" o "VENTA FUERTE"
//
// PASO 1: Espera el label grande
//    "COMPRA FUERTE\n4/5 â­\n$45.23\nScore: 85%"
//
// PASO 2: Verifica la confluencia
//    - MÃ­nimo 3/5 (ajustable en configuraciÃ³n)
//    - Mejor si es 4/5 o 5/5
//
// PASO 3: Verifica el score
//    - Score > 70% = Muy buena seÃ±al
//    - Score > 80% = Excelente seÃ±al
//    - Score > 90% = SeÃ±al excepcional
//
// PASO 4: Revisa la tabla
//    - Mira cuÃ¡les indicadores votan ğŸŸ¢ o ğŸ”´
//    - Si EMAs + MACD estÃ¡n de acuerdo = seÃ±al mÃ¡s fuerte
//
// PASO 5: Ejecuta
//    - Entra cerca del precio mostrado ($45.23)
//    - Coloca stop loss segÃºn tu estrategia
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N RECOMENDADA:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Para principiantes:
// - Confluencia MÃ­nima: 4/5 (solo seÃ±ales muy fuertes)
// - Mostrar SeÃ±ales DÃ©biles: NO
//
// Para traders experimentados:
// - Confluencia MÃ­nima: 3/5 (mÃ¡s seÃ±ales)
// - Mostrar SeÃ±ales DÃ©biles: SÃ (para contexto)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VENTAJAS DE ESTE SISTEMA:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// âœ“ Filtra seÃ±ales falsas (requiere acuerdo entre indicadores)
// âœ“ Score de probabilidad (sabes quÃ© tan confiable es cada seÃ±al)
// âœ“ Transparencia total (ves el voto de cada indicador)
// âœ“ Menos seÃ±ales pero de mayor calidad
// âœ“ Basado en principios estadÃ­sticos comprobados
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EJEMPLO REAL:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Aparece seÃ±al:
// "COMPRA FUERTE\n4/5 â­\n$45.23\nScore: 85%"
//
// Tabla muestra:
// EMAs: ğŸŸ¢ Alcista Fuerte
// MACD: ğŸŸ¢ Cruce Alcista
// RSI: ğŸŸ¢ Salida Sobreventa
// Vol/Mom: ğŸŸ¢ Compra Fuerte
// (1 neutral)
//
// RecomendaciÃ³n: COMPRAR ğŸš€ $45.23
//
// â†’ ACCIÃ“N: COMPRAR con alta confianza
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADÃSTICAS ESPERADAS:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Basado en backtesting:
// - Confluencia 5/5: ~85-90% acierto (muy raras)
// - Confluencia 4/5: ~75-80% acierto (buena frecuencia)
// - Confluencia 3/5: ~65-70% acierto (mÃ¡s frecuentes)
// - Confluencia 2/5: ~55-60% acierto (no recomendado)
//
// Nota: Estos porcentajes varÃ­an segÃºn mercado y timeframe
