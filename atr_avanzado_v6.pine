//@version=6
//Â© Diego Santacruz
indicator(title="ATR Avanzado - GestiÃ³n de Riesgo v6", shorttitle="ATR Pro", overlay=false)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ATR
atr_length = input.int(14, "ATR Length", minval=1, group="ATR")
atr_smoothing = input.string("RMA", "Smoothing", options=["RMA", "SMA", "EMA", "WMA"], group="ATR")

// GestiÃ³n de riesgo
risk_percentage = input.float(1.0, "Riesgo por Trade (%)", minval=0.1, maxval=10, step=0.1, group="GestiÃ³n de Riesgo")
account_size = input.float(10000, "TamaÃ±o de Cuenta ($)", minval=100, group="GestiÃ³n de Riesgo")
stop_loss_multiplier = input.float(2.0, "Stop Loss (x ATR)", minval=0.5, maxval=5, step=0.5, group="GestiÃ³n de Riesgo")
take_profit_ratio = input.float(2.0, "Ratio Riesgo:Recompensa", minval=1, maxval=5, step=0.5, group="GestiÃ³n de Riesgo")

// Zonas de volatilidad
volatility_threshold_low = input.float(0.7, "Umbral Volatilidad Baja", minval=0.1, maxval=1, step=0.1, group="Volatilidad")
volatility_threshold_high = input.float(1.3, "Umbral Volatilidad Alta", minval=1, maxval=3, step=0.1, group="Volatilidad")

// VisualizaciÃ³n
show_zones = input.bool(true, "Mostrar Zonas de Volatilidad", group="VisualizaciÃ³n")
show_table = input.bool(true, "Mostrar Tabla de Riesgo", group="VisualizaciÃ³n")
show_stop_levels = input.bool(true, "Mostrar Niveles en Chart", group="VisualizaciÃ³n")

// Alertas
enable_alerts = input.bool(true, "Activar Alertas", group="Alertas")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOM TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

type ATRAnalysis
    float current_atr          // ATR actual
    float avg_atr              // ATR promedio
    float atr_ratio            // Ratio ATR actual vs promedio
    string volatility_state    // Estado de volatilidad
    color zone_color           // Color de la zona

type RiskCalculation
    float stop_distance        // Distancia del stop loss
    float stop_price_long      // Precio stop para long
    float stop_price_short     // Precio stop para short
    float take_profit_long     // Precio take profit para long
    float take_profit_short    // Precio take profit para short
    float position_size        // TamaÃ±o de posiciÃ³n (acciones)
    float risk_amount          // Cantidad en riesgo ($)
    float reward_amount        // Recompensa potencial ($)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNCIONES DE CÃLCULO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Calcular ATR con diferentes mÃ©todos de suavizado
calc_atr(length, smoothing_method) =>
    tr = ta.tr
    atr_value = switch smoothing_method
        "RMA" => ta.rma(tr, length)
        "SMA" => ta.sma(tr, length)
        "EMA" => ta.ema(tr, length)
        "WMA" => ta.wma(tr, length)
        => ta.rma(tr, length)
    atr_value

// Analizar estado del ATR
analyze_atr(current_atr, avg_length) =>
    // Calcular ATR promedio (Ãºltimo mes)
    avg_atr = ta.sma(current_atr, avg_length)

    // Ratio ATR actual vs promedio
    atr_ratio = avg_atr != 0 ? current_atr / avg_atr : 1.0

    // Determinar estado de volatilidad
    volatility_state =
         atr_ratio < volatility_threshold_low ? "MUY BAJA ğŸŸ¢" :
         atr_ratio > volatility_threshold_high ? "MUY ALTA ğŸ”´" :
         atr_ratio < 0.9 ? "BAJA ğŸŸ¡" :
         atr_ratio > 1.1 ? "ALTA ğŸŸ " : "NORMAL âšª"

    // Color de zona
    zone_color =
         atr_ratio < volatility_threshold_low ? color.new(color.green, 80) :
         atr_ratio > volatility_threshold_high ? color.new(color.red, 80) :
         atr_ratio < 0.9 ? color.new(color.yellow, 80) :
         atr_ratio > 1.1 ? color.new(color.orange, 80) : color.new(color.gray, 90)

    ATRAnalysis.new(current_atr, avg_atr, atr_ratio, volatility_state, zone_color)

// Calcular niveles de riesgo
calc_risk_levels(current_price, atr_value, multiplier, rr_ratio, risk_pct, account) =>
    // Distancia del stop loss
    stop_distance = atr_value * multiplier

    // Niveles para posiciÃ³n LONG
    stop_long = current_price - stop_distance
    tp_long = current_price + (stop_distance * rr_ratio)

    // Niveles para posiciÃ³n SHORT
    stop_short = current_price + stop_distance
    tp_short = current_price - (stop_distance * rr_ratio)

    // Calcular tamaÃ±o de posiciÃ³n
    risk_dollars = account * (risk_pct / 100)
    position_size = stop_distance != 0 ? risk_dollars / stop_distance : 0

    // Recompensa potencial
    reward_dollars = risk_dollars * rr_ratio

    RiskCalculation.new(stop_distance, stop_long, stop_short, tp_long, tp_short, position_size, risk_dollars, reward_dollars)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃLCULOS PRINCIPALES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Calcular ATR
atr = calc_atr(atr_length, atr_smoothing)

// Analizar ATR
atr_analysis = analyze_atr(atr, 20)

// Calcular niveles de riesgo
risk = calc_risk_levels(close, atr, stop_loss_multiplier, take_profit_ratio, risk_percentage, account_size)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETECCIÃ“N DE CAMBIOS SIGNIFICATIVOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Detectar picos de volatilidad
volatility_spike = atr_analysis.atr_ratio > volatility_threshold_high and (na(atr_analysis[1]) ? false : (atr_analysis[1]).atr_ratio <= volatility_threshold_high)
volatility_drop = atr_analysis.atr_ratio < volatility_threshold_low and (na(atr_analysis[1]) ? false : (atr_analysis[1]).atr_ratio >= volatility_threshold_low)

// Cambio de zona
zone_change = na(atr_analysis[1]) ? false : atr_analysis.volatility_state != (atr_analysis[1]).volatility_state

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PLOTEO DEL ATR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ATR actual
plot(atr, "ATR", color=color.new(#2196F3, 0), linewidth=2)

// ATR promedio
plot(atr_analysis.avg_atr, "ATR Promedio", color=color.new(#FF9800, 0), linewidth=1, style=plot.style_line)

// LÃ­neas de umbral (dinÃ¡micas)
plot(atr_analysis.avg_atr * volatility_threshold_high, "Umbral Alto", color=color.new(color.red, 50), linewidth=1, style=plot.style_circles)
plot(atr_analysis.avg_atr * volatility_threshold_low, "Umbral Bajo", color=color.new(color.green, 50), linewidth=1, style=plot.style_circles)

// Zona de volatilidad (fondo)
bgcolor(show_zones ? atr_analysis.zone_color : na, title="Zona de Volatilidad")

// Relleno entre ATR y promedio
fill_color = atr > atr_analysis.avg_atr ? color.new(color.green, 90) : color.new(color.red, 90)
fill(plot(atr), plot(atr_analysis.avg_atr), color=fill_color, title="Relleno ATR")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARCADORES DE EVENTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Pico de volatilidad
plotshape(volatility_spike, "Pico Volatilidad", shape.circle, location.top,
     color.new(color.red, 0), size=size.small, text="âš ï¸")

// CaÃ­da de volatilidad
plotshape(volatility_drop, "CaÃ­da Volatilidad", shape.circle, location.bottom,
     color.new(color.green, 0), size=size.small, text="âœ“")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NIVELES EN EL CHART PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Dibujar niveles en el chart principal (usando plots invisibles para exportar)
plot(show_stop_levels ? risk.stop_price_long : na, "Stop Long", display=display.none)
plot(show_stop_levels ? risk.take_profit_long : na, "TP Long", display=display.none)
plot(show_stop_levels ? risk.stop_price_short : na, "Stop Short", display=display.none)
plot(show_stop_levels ? risk.take_profit_short : na, "TP Short", display=display.none)

// Labels en el chart (solo Ãºltima barra)
if show_stop_levels and barstate.islast
    var line stop_long_line = na
    var line tp_long_line = na
    var label stop_long_label = na
    var label tp_long_label = na

    // Limpiar lÃ­neas anteriores
    line.delete(stop_long_line)
    line.delete(tp_long_line)
    label.delete(stop_long_label)
    label.delete(tp_long_label)

    // Dibujar lÃ­neas de stop y TP para LONG
    stop_long_line := line.new(bar_index - 20, risk.stop_price_long, bar_index, risk.stop_price_long,
         color=color.new(color.red, 0), style=line.style_dashed, width=1)

    tp_long_line := line.new(bar_index - 20, risk.take_profit_long, bar_index, risk.take_profit_long,
         color=color.new(color.green, 0), style=line.style_dashed, width=1)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLA DE GESTIÃ“N DE RIESGO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if show_table and barstate.islast
    var table risk_table = table.new(position.top_right, 2, 13,
         border_width=1,
         border_color=color.gray,
         frame_width=1,
         frame_color=color.gray)

    // Header
    table.cell(risk_table, 0, 0, "ATR & GestiÃ³n de Riesgo",
         text_color=color.white,
         bgcolor=color.new(color.blue, 20),
         text_size=size.normal)
    table.merge_cells(risk_table, 0, 0, 1, 0)

    // Precio actual
    table.cell(risk_table, 0, 1, "Precio Actual",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(risk_table, 1, 1, "$" + str.tostring(close, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.blue, 70),
         text_size=size.small)

    // ATR actual
    table.cell(risk_table, 0, 2, "ATR Actual",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(risk_table, 1, 2, "$" + str.tostring(atr, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.small)

    // ATR Promedio
    table.cell(risk_table, 0, 3, "ATR Promedio",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(risk_table, 1, 3, "$" + str.tostring(atr_analysis.avg_atr, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.gray, 80),
         text_size=size.small)

    // Estado de volatilidad
    table.cell(risk_table, 0, 4, "Volatilidad",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(risk_table, 1, 4, atr_analysis.volatility_state,
         text_color=color.white,
         bgcolor=atr_analysis.zone_color,
         text_size=size.small)

    // Separador
    table.cell(risk_table, 0, 5, "â”€â”€ POSICIÃ“N LONG â”€â”€",
         text_color=color.white,
         bgcolor=color.new(color.green, 50),
         text_size=size.small)
    table.merge_cells(risk_table, 0, 5, 1, 5)

    // Stop Loss LONG
    table.cell(risk_table, 0, 6, "Stop Loss",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(risk_table, 1, 6, "$" + str.tostring(risk.stop_price_long, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.red, 70),
         text_size=size.small)

    // Take Profit LONG
    table.cell(risk_table, 0, 7, "Take Profit",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(risk_table, 1, 7, "$" + str.tostring(risk.take_profit_long, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.green, 70),
         text_size=size.small)

    // Separador
    table.cell(risk_table, 0, 8, "â”€â”€ POSICIÃ“N SHORT â”€â”€",
         text_color=color.white,
         bgcolor=color.new(color.red, 50),
         text_size=size.small)
    table.merge_cells(risk_table, 0, 8, 1, 8)

    // Stop Loss SHORT
    table.cell(risk_table, 0, 9, "Stop Loss",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(risk_table, 1, 9, "$" + str.tostring(risk.stop_price_short, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.red, 70),
         text_size=size.small)

    // Take Profit SHORT
    table.cell(risk_table, 0, 10, "Take Profit",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(risk_table, 1, 10, "$" + str.tostring(risk.take_profit_short, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.green, 70),
         text_size=size.small)

    // Separador
    table.cell(risk_table, 0, 11, "â”€â”€ TAMAÃ‘O POSICIÃ“N â”€â”€",
         text_color=color.white,
         bgcolor=color.new(color.purple, 50),
         text_size=size.small)
    table.merge_cells(risk_table, 0, 11, 1, 11)

    // TamaÃ±o de posiciÃ³n
    table.cell(risk_table, 0, 12, "Acciones",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(risk_table, 1, 12, str.tostring(math.floor(risk.position_size), "#") + " acciones",
         text_color=color.white,
         bgcolor=color.new(color.purple, 70),
         text_size=size.small)

// Segunda tabla: Resumen de riesgo/recompensa
if show_table and barstate.islast
    var table summary_table = table.new(position.bottom_right, 2, 4,
         border_width=2,
         border_color=color.gray,
         frame_width=2,
         frame_color=color.gray)

    // Header
    table.cell(summary_table, 0, 0, "RESUMEN DE RIESGO",
         text_color=color.white,
         bgcolor=color.new(color.orange, 20),
         text_size=size.normal)
    table.merge_cells(summary_table, 0, 0, 1, 0)

    // Riesgo
    table.cell(summary_table, 0, 1, "Riesgo",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(summary_table, 1, 1, "$" + str.tostring(risk.risk_amount, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.red, 70),
         text_size=size.small)

    // Recompensa
    table.cell(summary_table, 0, 2, "Recompensa",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(summary_table, 1, 2, "$" + str.tostring(risk.reward_amount, "#.##"),
         text_color=color.white,
         bgcolor=color.new(color.green, 70),
         text_size=size.small)

    // Ratio R:R
    table.cell(summary_table, 0, 3, "Ratio R:R",
         text_color=color.white,
         bgcolor=color.new(color.gray, 50),
         text_size=size.small)
    table.cell(summary_table, 1, 3, "1:" + str.tostring(take_profit_ratio, "#.#"),
         text_color=color.white,
         bgcolor=color.new(color.blue, 70),
         text_size=size.small)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

alertcondition(enable_alerts and volatility_spike,
     "Pico de Volatilidad",
     "âš ï¸ VOLATILIDAD MUY ALTA - ATR: {{plot_0}} ({{plot_1}}x promedio)")

alertcondition(enable_alerts and volatility_drop,
     "CaÃ­da de Volatilidad",
     "âœ“ Volatilidad normalizada - ATR: {{plot_0}}")

alertcondition(enable_alerts and zone_change,
     "Cambio de Zona de Volatilidad",
     "La zona de volatilidad ha cambiado. Revisar ATR actual.")

// Plots para alertas
plot(atr, "ATR Value", display=display.none)
plot(atr_analysis.atr_ratio, "ATR Ratio", display=display.none)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GUÃA DE USO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ATR AVANZADO - GESTIÃ“N DE RIESGO
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Â¿QUÃ‰ ES ATR (Average True Range)?
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// ATR mide la VOLATILIDAD promedio del mercado en tÃ©rminos de precio.
// NO es un indicador de tendencia, es un medidor de MOVIMIENTO.
//
// ATR alto = El precio se mueve mucho (volatilidad alta)
// ATR bajo = El precio se mueve poco (volatilidad baja)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃ“MO LEER EL GRÃFICO:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// LÃ­nea AZUL: ATR actual
// LÃ­nea NARANJA: ATR promedio (20 perÃ­odos)
// LÃ­neas PUNTEADAS: Umbrales de volatilidad
//
// Fondo de color:
// ğŸŸ¢ Verde = Volatilidad MUY BAJA (mercado tranquilo)
// ğŸŸ¡ Amarillo = Volatilidad BAJA
// âšª Gris = Volatilidad NORMAL
// ğŸŸ  Naranja = Volatilidad ALTA
// ğŸ”´ Rojo = Volatilidad MUY ALTA (mercado agitado)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLA DE GESTIÃ“N DE RIESGO:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// SECCIÃ“N 1: InformaciÃ³n del ATR
// - Precio Actual: Precio de cierre actual
// - ATR Actual: Volatilidad del momento ($)
// - ATR Promedio: Volatilidad promedio reciente
// - Volatilidad: Estado actual del mercado
//
// SECCIÃ“N 2: POSICIÃ“N LONG (Compra)
// - Stop Loss: Donde colocar el stop si compras
// - Take Profit: Objetivo de ganancia
//
// SECCIÃ“N 3: POSICIÃ“N SHORT (Venta)
// - Stop Loss: Donde colocar el stop si vendes
// - Take Profit: Objetivo de ganancia
//
// SECCIÃ“N 4: TAMAÃ‘O POSICIÃ“N
// - Acciones: CuÃ¡ntas acciones comprar segÃºn tu riesgo
//
// TABLA RESUMEN:
// - Riesgo: Cantidad que arriesgas en $ (ej: $100)
// - Recompensa: Ganancia potencial en $ (ej: $200)
// - Ratio R:R: ProporciÃ³n riesgo:recompensa (ej: 1:2)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃ“MO USAR PARA TRADING:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// PASO 1: Identifica tu seÃ±al de entrada
// (Usa Sistema de Confluencia, Medias, etc.)
//
// PASO 2: Mira la tabla de ATR
// Ejemplo: Precio = $100
//
// PASO 3: Si vas LONG (compra):
// - Stop Loss: $94.00 (de la tabla)
// - Take Profit: $112.00 (de la tabla)
// - Acciones: 16 acciones (de la tabla)
//
// PASO 4: Ejecuta el trade
// - Compra 16 acciones a $100
// - Coloca stop en $94.00
// - Coloca lÃ­mite en $112.00
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AJUSTES RECOMENDADOS:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Conservador:
// - Stop Loss: 3x ATR (stops mÃ¡s amplios)
// - Riesgo: 0.5% por trade
// - Ratio R:R: 3:1
//
// EstÃ¡ndar (recomendado):
// - Stop Loss: 2x ATR
// - Riesgo: 1% por trade
// - Ratio R:R: 2:1
//
// Agresivo:
// - Stop Loss: 1.5x ATR (stops mÃ¡s ajustados)
// - Riesgo: 2% por trade
// - Ratio R:R: 1.5:1
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADOS DE VOLATILIDAD Y QUÃ‰ HACER:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// ğŸŸ¢ MUY BAJA:
// - Mercado aburrido, rangos estrechos
// - AcciÃ³n: Esperar ruptura o evitar operar
// - Stops: MÃ¡s ajustados (1.5x ATR)
//
// ğŸŸ¡ BAJA:
// - Mercado tranquilo
// - AcciÃ³n: Operar con precauciÃ³n
// - Stops: Normales (2x ATR)
//
// âšª NORMAL:
// - Condiciones ideales
// - AcciÃ³n: Operar con confianza
// - Stops: EstÃ¡ndar (2x ATR)
//
// ğŸŸ  ALTA:
// - Mercado activo
// - AcciÃ³n: Reducir tamaÃ±o de posiciÃ³n
// - Stops: MÃ¡s amplios (2.5x ATR)
//
// ğŸ”´ MUY ALTA:
// - Mercado muy volÃ¡til (noticias, eventos)
// - AcciÃ³n: Evitar nuevas entradas o reducir tamaÃ±o
// - Stops: Mucho mÃ¡s amplios (3x ATR)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EJEMPLO COMPLETO:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// SituaciÃ³n:
// - Sistema de Confluencia da seÃ±al COMPRA en $100
// - Cuenta: $10,000
// - Riesgo: 1%
//
// Tabla muestra:
// - ATR Actual: $3.00
// - Volatilidad: NORMAL âšª
// - Stop Loss (Long): $94.00
// - Take Profit (Long): $112.00
// - Acciones: 33 acciones
// - Riesgo: $100
// - Recompensa: $200
// - Ratio: 1:2
//
// EjecuciÃ³n:
// 1. Comprar 33 acciones a $100 = $3,300 invertido
// 2. Stop loss en $94.00
// 3. Take profit en $112.00
// 4. Si el stop se activa: pierdes $100 (1% de cuenta)
// 5. Si el TP se activa: ganas $200 (2% de cuenta)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VENTAJAS DE ESTE SISTEMA:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// âœ“ Stops basados en volatilidad real (no arbitrarios)
// âœ“ TamaÃ±o de posiciÃ³n calculado automÃ¡ticamente
// âœ“ Riesgo controlado (siempre arriesgas el mismo %)
// âœ“ Ratio R:R favorable (ganas mÃ¡s de lo que arriesgas)
// âœ“ Se adapta a condiciones del mercado
// âœ“ Profesional (usado por instituciones)
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTEGRACIÃ“N CON OTROS INDICADORES:
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// Sistema de Confluencia + ATR:
// 1. Confluencia da seÃ±al COMPRA 4/5 en $100
// 2. ATR dice: Stop en $94, TP en $112, comprar 33 acciones
// 3. Ejecutas con gestiÃ³n de riesgo profesional
//
// â†’ MÃXIMA EFECTIVIDAD
