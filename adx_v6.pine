//@version=6
indicator("ADX v6", shorttitle="ADX v6", format=format.price, precision=2)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================

// Calculation Settings
var g_calc = "Calculation Settings"
adx_length = input.int(14, title="ADX Length", minval=1, group=g_calc, tooltip="Period for ADX calculation (default: 14)")
adx_smoothing = input.int(14, title="DI Smoothing", minval=1, group=g_calc, tooltip="Smoothing period for DI+ and DI- (default: 14)")

// Display Settings
var g_display = "Display Settings"
show_adx = input.bool(true, title="Show ADX Line", group=g_display, inline="lines1")
show_di_plus = input.bool(true, title="Show DI+", group=g_display, inline="lines1")
show_di_minus = input.bool(true, title="Show DI-", group=g_display, inline="lines2")
show_threshold_lines = input.bool(true, title="Show Threshold Lines", group=g_display, inline="lines2")
threshold_strong = input.int(25, title="Strong Trend Threshold", minval=1, maxval=100, group=g_display, tooltip="ADX above this level indicates strong trend")
threshold_weak = input.int(20, title="Weak Trend Threshold", minval=1, maxval=100, group=g_display, tooltip="ADX below this level indicates weak/no trend")
show_signals = input.bool(true, title="Show DI+/DI- Cross Signals", group=g_display)
show_histogram = input.bool(true, title="Show DI Histogram", group=g_display, tooltip="Histogram showing DI+ - DI-")
show_minmax = input.bool(true, title="Show Min/Max Lines", group=g_display)
minmax_lookback = input.int(3000, title="Min/Max Lookback Bars", minval=100, maxval=5000, group=g_display)
show_table = input.bool(true, title="Show Statistics Table", group=g_display)
table_position = input.string("top_right", title="Table Position", options=["top_left", "top_center", "top_right", "middle_left", "middle_center", "middle_right", "bottom_left", "bottom_center", "bottom_right"], group=g_display)

// Color Settings
var g_colors = "Color Settings"
color_adx = input.color(color.new(#000000, 0), title="ADX Line", group=g_colors, inline="lines1")
color_di_plus = input.color(color.new(#00FF00, 0), title="DI+ Line", group=g_colors, inline="lines2")
color_di_minus = input.color(color.new(#FF0000, 0), title="DI- Line", group=g_colors, inline="lines3")
color_histogram_bull = input.color(color.new(#00AA00, 0), title="Bullish Histogram", group=g_colors, inline="hist")
color_histogram_bear = input.color(color.new(#AA0000, 0), title="Bearish Histogram", group=g_colors, inline="hist")

// ============================================================================
// CUSTOM TYPES
// ============================================================================

type ADXResult
    float adx
    float di_plus
    float di_minus
    float di_diff  // DI+ - DI-
    bool strong_trend
    bool weak_trend
    bool bullish_di  // DI+ > DI-
    bool di_cross_bull
    bool di_cross_bear

type MinMaxRange
    float adx_min
    float adx_max
    int lookback_bars

type TrendStats
    int strong_trend_bars
    int weak_trend_bars
    int total_bars
    float pct_strong
    float pct_weak
    float avg_adx

// ============================================================================
// CORE FUNCTIONS
// ============================================================================

// Calculate True Range
calc_tr() =>
    math.max(high - low, math.abs(high - close[1]), math.abs(low - close[1]))

// Calculate Directional Movement
calc_dm() =>
    up_move = high - high[1]
    down_move = low[1] - low

    plus_dm = (up_move > down_move and up_move > 0) ? up_move : 0
    minus_dm = (down_move > up_move and down_move > 0) ? down_move : 0

    [plus_dm, minus_dm]

// Calculate smoothed values using Wilder's smoothing (RMA)
calc_smoothed(src, length) =>
    ta.rma(src, length)

// Calculate ADX and DI
calc_adx(adx_len, di_smooth_len) =>
    // Calculate True Range and Directional Movement
    tr = calc_tr()
    [plus_dm, minus_dm] = calc_dm()

    // Smooth TR and DM
    smoothed_tr = calc_smoothed(tr, di_smooth_len)
    smoothed_plus_dm = calc_smoothed(plus_dm, di_smooth_len)
    smoothed_minus_dm = calc_smoothed(minus_dm, di_smooth_len)

    // Calculate DI+ and DI-
    di_plus = (smoothed_plus_dm / smoothed_tr) * 100
    di_minus = (smoothed_minus_dm / smoothed_tr) * 100

    // Calculate DX (Directional Movement Index)
    dx = (math.abs(di_plus - di_minus) / (di_plus + di_minus)) * 100

    // Calculate ADX (smoothed DX)
    adx = calc_smoothed(dx, adx_len)

    // Additional metrics
    di_diff = di_plus - di_minus
    strong_trend = adx >= threshold_strong
    weak_trend = adx <= threshold_weak
    bullish_di = di_plus > di_minus
    di_cross_bull = ta.crossover(di_plus, di_minus)
    di_cross_bear = ta.crossunder(di_plus, di_minus)

    ADXResult.new(adx, di_plus, di_minus, di_diff, strong_trend, weak_trend, bullish_di, di_cross_bull, di_cross_bear)

// Calculate min/max for ADX
calc_minmax(adx_value, lookback) =>
    bars_back = math.min(bar_index + 1, lookback)
    adx_min = ta.lowest(adx_value, bars_back)
    adx_max = ta.highest(adx_value, bars_back)

    MinMaxRange.new(adx_min, adx_max, bars_back)

// ============================================================================
// CUSTOM METHODS
// ============================================================================

// Get trend strength description
method get_trend_strength(ADXResult this) =>
    switch
        this.adx >= 50 => "Very Strong"
        this.adx >= threshold_strong => "Strong"
        this.adx >= threshold_weak => "Moderate"
        => "Weak/Ranging"

// Get trend direction
method get_trend_direction(ADXResult this) =>
    if this.bullish_di
        "Bullish"
    else
        "Bearish"

// Get trading signal
method get_signal(ADXResult this) =>
    switch
        this.di_cross_bull and this.strong_trend => "STRONG BUY"
        this.di_cross_bull => "BUY"
        this.di_cross_bear and this.strong_trend => "STRONG SELL"
        this.di_cross_bear => "SELL"
        this.weak_trend => "NO TREND"
        => "HOLD"

// Get signal color
method get_signal_color(ADXResult this) =>
    signal = this.get_signal()
    switch signal
        "STRONG BUY" => color.new(#00FF00, 0)
        "BUY" => color.new(#00AA00, 0)
        "STRONG SELL" => color.new(#FF0000, 0)
        "SELL" => color.new(#AA0000, 0)
        "NO TREND" => color.new(#999999, 0)
        => color.gray

// Get ADX line color based on strength
method get_adx_color(ADXResult this) =>
    switch
        this.adx >= 50 => color.new(#0000FF, 0)  // Very strong = blue
        this.adx >= threshold_strong => color.new(#000000, 0)  // Strong = black
        this.adx >= threshold_weak => color.new(#666666, 0)  // Moderate = gray
        => color.new(#CCCCCC, 0)  // Weak = light gray

// Get histogram color
method get_histogram_color(ADXResult this) =>
    this.bullish_di ? color_histogram_bull : color_histogram_bear

// Update trend statistics
method update_stats(TrendStats this, ADXResult adx_result) =>
    this.total_bars += 1

    if adx_result.strong_trend
        this.strong_trend_bars += 1

    if adx_result.weak_trend
        this.weak_trend_bars += 1

    // Calculate percentages
    this.pct_strong := (this.strong_trend_bars / this.total_bars) * 100
    this.pct_weak := (this.weak_trend_bars / this.total_bars) * 100

    // Calculate average ADX (cumulative moving average)
    this.avg_adx := ((this.avg_adx * (this.total_bars - 1)) + adx_result.adx) / this.total_bars

    this

// ============================================================================
// CALCULATIONS
// ============================================================================

// Calculate ADX
adx_result = calc_adx(adx_length, adx_smoothing)

// Store ADX value for history reference (needed for alerts)
adx_value = adx_result.adx

// Calculate min/max
minmax = calc_minmax(adx_result.adx, minmax_lookback)

// Calculate statistics
var stats = TrendStats.new(0, 0, 0, 0.0, 0.0, 0.0)
stats.update_stats(adx_result)

// ============================================================================
// PLOTTING
// ============================================================================

// Plot ADX line with dynamic color
plot(show_adx ? adx_result.adx : na, title="ADX", color=adx_result.get_adx_color(), linewidth=2)

// Plot DI+ and DI-
plot(show_di_plus ? adx_result.di_plus : na, title="DI+", color=color_di_plus, linewidth=1)
plot(show_di_minus ? adx_result.di_minus : na, title="DI-", color=color_di_minus, linewidth=1)

// Plot DI histogram (DI+ - DI-)
plot(show_histogram ? adx_result.di_diff : na, title="DI Histogram", color=adx_result.get_histogram_color(), style=plot.style_histogram, linewidth=2)

// Plot threshold lines
hline(threshold_strong, title="Strong Trend", color=show_threshold_lines ? color.new(#00AA00, 50) : na, linestyle=hline.style_dashed, linewidth=1)
hline(threshold_weak, title="Weak Trend", color=show_threshold_lines ? color.new(#AA0000, 50) : na, linestyle=hline.style_dashed, linewidth=1)

// Plot min/max lines (using plot because they are dynamic values)
plot(show_minmax ? minmax.adx_max : na, title="ADX Max", color=color.new(#0000FF, 50), style=plot.style_line, linewidth=1)
plot(show_minmax ? minmax.adx_min : na, title="ADX Min", color=color.new(#999999, 50), style=plot.style_line, linewidth=1)

// Plot buy/sell signals on DI cross
plotshape(
     show_signals and adx_result.di_cross_bull,
     title="DI+ Cross Above DI-",
     style=shape.triangleup,
     location=location.bottom,
     color=color.new(#00FF00, 0),
     size=size.small,
     text="BUY"
 )

plotshape(
     show_signals and adx_result.di_cross_bear,
     title="DI- Cross Above DI+",
     style=shape.triangledown,
     location=location.top,
     color=color.new(#FF0000, 0),
     size=size.small,
     text="SELL"
 )

// ============================================================================
// STATISTICS TABLE
// ============================================================================

if show_table and barstate.islast
    // Parse table position
    pos = switch table_position
        "top_left" => position.top_left
        "top_center" => position.top_center
        "top_right" => position.top_right
        "middle_left" => position.middle_left
        "middle_center" => position.middle_center
        "middle_right" => position.middle_right
        "bottom_left" => position.bottom_left
        "bottom_center" => position.bottom_center
        "bottom_right" => position.bottom_right
        => position.top_right

    // Create table
    var tbl = table.new(pos, 2, 7, border_width=1)

    // Header
    table.cell(tbl, 0, 0, "ADX Statistics", text_color=color.white, bgcolor=color.gray, text_size=size.normal)
    table.merge_cells(tbl, 0, 0, 1, 0)

    // Current Signal
    table.cell(tbl, 0, 1, "Signal", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(tbl, 1, 1, adx_result.get_signal(), text_color=color.white, bgcolor=adx_result.get_signal_color(), text_size=size.small)

    // ADX Value
    adx_text = str.tostring(adx_result.adx, "#.##")
    table.cell(tbl, 0, 2, "ADX Value", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(tbl, 1, 2, adx_text, text_color=color.white, bgcolor=adx_result.get_adx_color(), text_size=size.small)

    // Trend Strength
    table.cell(tbl, 0, 3, "Trend Strength", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(tbl, 1, 3, adx_result.get_trend_strength(), text_color=color.white, bgcolor=adx_result.get_adx_color(), text_size=size.small)

    // Trend Direction
    dir_color = adx_result.bullish_di ? color.new(#00AA00, 30) : color.new(#AA0000, 30)
    table.cell(tbl, 0, 4, "Direction (DI)", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(tbl, 1, 4, adx_result.get_trend_direction(), text_color=color.white, bgcolor=dir_color, text_size=size.small)

    // Average ADX
    avg_adx_text = str.tostring(stats.avg_adx, "#.##")
    table.cell(tbl, 0, 5, "Average ADX", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(tbl, 1, 5, avg_adx_text, text_color=color.white, bgcolor=color.new(color.gray, 50), text_size=size.small)

    // Strong Trend %
    strong_pct_text = str.tostring(stats.pct_strong, "#.#") + "%"
    table.cell(tbl, 0, 6, "Strong Trend %", text_color=color.white, bgcolor=color.gray, text_size=size.small)
    table.cell(tbl, 1, 6, strong_pct_text, text_color=color.white, bgcolor=color.new(#00AA00, 50), text_size=size.small)

// ============================================================================
// ALERTS
// ============================================================================

alertcondition(adx_result.di_cross_bull and adx_result.strong_trend, title="Strong Buy Signal", message="ADX: STRONG BUY - DI+ crossed above DI- with strong trend")
alertcondition(adx_result.di_cross_bull, title="Buy Signal", message="ADX: BUY - DI+ crossed above DI-")
alertcondition(adx_result.di_cross_bear and adx_result.strong_trend, title="Strong Sell Signal", message="ADX: STRONG SELL - DI- crossed above DI+ with strong trend")
alertcondition(adx_result.di_cross_bear, title="Sell Signal", message="ADX: SELL - DI- crossed above DI+")
alertcondition(ta.cross(adx_value, threshold_strong), title="ADX Crossed Strong Threshold", message="ADX: Trend strength threshold crossed")
alertcondition(adx_result.strong_trend and adx_value > adx_value[1], title="Strong Trend Strengthening", message="ADX: Strong trend is getting stronger")
